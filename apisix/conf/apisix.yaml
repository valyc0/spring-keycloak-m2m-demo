routes:
  - id: 1
    uri: /hello-myworld
    upstream_id: 1
    plugins:
      # 1) Valida firma/scadenza token
      openid-connect:
        bearer_only: true
        client_id: service-a-client
        client_secret: service-a-secret
        discovery: http://host.docker.internal:8190/realms/rubrica-realm/.well-known/openid-configuration
        realm: rubrica-realm
        use_jwks: true
        claim_validator:
          issuer:
            valid_issuers:
              - http://localhost:8190/realms/rubrica-realm
              - http://host.docker.internal:8190/realms/rubrica-realm
        set_access_token_header: true
        ssl_verify: false

      # 2) Richiede ruolo CALL_B nel JWT (realm_access.roles)
      serverless-pre-function:
        phase: rewrite
        functions:
          - |
            return function(conf, ctx)
              local cjson = require("cjson.safe")

              local function deny(message)
                ngx.status = 403
                ngx.header.content_type = "application/json"
                ngx.say('{"message":"' .. message .. '"}')
                return ngx.exit(403)
              end

              local function decode_claims(token)
                local dot1 = token:find(".", 1, true)
                local dot2 = dot1 and token:find(".", dot1 + 1, true)
                if not dot2 then
                  return nil, "Malformed token"
                end

                local b64 = token:sub(dot1 + 1, dot2 - 1):gsub("-", "+"):gsub("_", "/")
                local pad = #b64 % 4
                if pad > 0 then
                  b64 = b64 .. ("="):rep(4 - pad)
                end

                local json_str = ngx.decode_base64(b64)
                if not json_str then
                  return nil, "Cannot decode token"
                end

                local claims = cjson.decode(json_str)
                if not claims then
                  return nil, "Cannot parse token"
                end

                return claims
              end

              local function has_role(claims, required_role)
                local roles = claims.realm_access and claims.realm_access.roles
                if type(roles) ~= "table" then
                  return false
                end
                for _, role in ipairs(roles) do
                  if role == required_role then
                    return true
                  end
                end
                return false
              end

              local auth = ngx.req.get_headers()["Authorization"]
              if not auth or not auth:find("Bearer ", 1, true) then
                return deny("Missing Bearer token")
              end

              local claims, err = decode_claims(auth:sub(8))
              if not claims then
                return deny(err)
              end

              if has_role(claims, "CALL_B") then
                return
              end

              return deny("Forbidden: role CALL_B is required")
            end

upstreams:
  - id: 1
    type: roundrobin
    nodes:
      "host.docker.internal:8082": 1

#END
