worker_processes 1;

error_log /dev/stderr info;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    lua_package_path '/usr/local/openresty/site/lualib/?.lua;/usr/local/openresty/site/lualib/?/init.lua;/usr/local/openresty/lualib/?.lua;/usr/local/openresty/lualib/?/init.lua;/etc/nginx/lua/?.lua;;';

    resolver 127.0.0.11 ipv6=off;

    upstream backend_service_open {
        server host.docker.internal:8082;
        keepalive 32;
    }

    server {
        listen 9080;
        server_name _;

        default_type application/json;

        location = /hello-myworld {
            access_by_lua_block {
                local guard = require("role_guard")
                guard.run("CALL_B")
            }

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_pass http://backend_service_open;
        }

        location = /hello-myworld1 {
            access_by_lua_block {
                local guard = require("role_guard")
                guard.run("CALL_C")
            }

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_pass http://backend_service_open;
        }

        location /health {
            access_log off;
            return 200 '{"status":"ok"}';
        }
    }
}
